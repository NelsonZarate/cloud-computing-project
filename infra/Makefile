# .PHONY diz ao Make que isto nÃ£o sÃ£o ficheiros, sÃ£o comandos
.PHONY: init nike airbnb mcdonalds clean destroy-all

# Inicializa o Terraform (faz o download dos providers)
init:
	terraform init

# --- CLIENTE NIKE ---
nike:
	@echo "--- ğŸ‘Ÿ A preparar ambiente NIKE ---"
	# Tenta selecionar o workspace 'nike', se nÃ£o existir, cria-o
	terraform workspace select nike || terraform workspace new nike
	terraform init
	# Aplica a configuraÃ§Ã£o usando as variÃ¡veis da Nike
	terraform apply -var-file="nike.tfvars" -auto-approve

# --- CLIENTE AIRBNB ---
airbnb:
	@echo "--- ğŸ  A preparar ambiente AIRBNB ---"
	terraform workspace select airbnb || terraform workspace new airbnb
	terraform init
	terraform apply -var-file="airbnb.tfvars" -auto-approve

# --- CLIENTE MCDONALDS ---
mcdonalds:
	@echo "--- ğŸ” A preparar ambiente MCDONALDS ---"
	terraform workspace select mcdonalds || terraform workspace new mcdonalds
	terraform init
	terraform apply -var-file="mcdonalds.tfvars" -auto-approve

# --- DESTRUIR TUDO (Cuidado!) ---
destroy-nike:
	terraform workspace select nike
	terraform destroy -var-file="nike.tfvars" -auto-approve

destroy-airbnb:
	terraform workspace select airbnb
	terraform destroy -var-file="airbnb.tfvars" -auto-approve

# --- LIMPEZA TOTAL ---
clean:
	@echo "--- ğŸ§¹ A limpar tudo... ---"
	# Remove ficheiros de estado locais e backups
	rm -rf terraform.tfstate*
	rm -rf .terraform/
	rm -rf .terraform.lock.hcl
	# Apaga todos os clusters minikube de uma vez
	minikube delete --all
	@echo "--- âœ¨ Limpeza concluÃ­da ---"

deploy-all: init nike airbnb mcdonalds
	@echo "--- âœ… Todos os clusters foram criados! ---"
	@echo "Para listar: minikube profile list"

destroy-all: destroy-nike destroy-airbnb destroy-mcdonalds
	@echo "--- ğŸ’¥ Tudo destruÃ­do. O teu PC estÃ¡ leve novamente. ---"


CLIENTS_LIST = nike airbnb mcdonalds

ENVS_airbnb   = dev prod
ENVS_mcdonalds = dev qa beta prod
ENVS_nike     = dev qa prod
update-hosts:
	@echo "--- ğŸ”„ A atualizar /etc/hosts ---"

	@sed '/#TF-Project/d' /etc/hosts > /tmp/hosts.tmp
	@cat /tmp/hosts.tmp > /etc/hosts
	@rm /tmp/hosts.tmp

	@for client in $(CLIENTS_LIST); do \
		case "$$client" in \
			airbnb)    ENVS="dev prod" ;; \
			mcdonalds) ENVS="dev qa beta prod" ;; \
			nike)      ENVS="dev qa prod" ;; \
		esac; \
		if minikube status -p "$$client-cluster" >/dev/null 2>&1; then \
			IP=$$(minikube ip -p "$$client-cluster"); \
			DOMAINS=""; \
			for env in $$ENVS; do \
				DOMAINS="$$DOMAINS odoo.$$env.$$client.local"; \
			done; \
			echo "A adicionar: $$IP -> $$DOMAINS"; \
			echo "$$IP $$DOMAINS #TF-Project" >> /etc/hosts; \
		else \
			echo "âš ï¸  Cluster $$client-cluster estÃ¡ desligado (ignorado)."; \
		fi; \
	done

	@echo "--- âœ… /etc/hosts atualizado com sucesso! ---"

curl-test:
	@echo "--- ğŸ“¡ A iniciar bateria de testes CURL ---"
	@for client in $(CLIENTS_LIST); do \
		case "$$client" in \
			airbnb)    ENVS="dev prod" ;; \
			mcdonalds) ENVS="dev qa beta prod" ;; \
			nike)      ENVS="dev qa prod" ;; \
		esac; \
		echo "----------------------------------------"; \
		echo "ğŸ” Cliente: $$client"; \
		for env in $$ENVS; do \
			URL="https://odoo.$$env.$$client.local"; \
			STATUS=$$(curl -k -s -o /dev/null -w "%{http_code}" --connect-timeout 2 $$URL || echo "DOWN"); \
			if [ "$$STATUS" = "DOWN" ]; then \
				echo "   âŒ [$$env] -> Falha de ConexÃ£o (Cluster desligado?)"; \
			elif [ "$$STATUS" = "303" ] || [ "$$STATUS" = "308" ]; then \
				echo "   âœ… [$$env] -> HTTPS $$STATUS (Sucesso!)"; \
			else \
				echo "   âš ï¸ [$$env] -> HTTPS $$STATUS (Algo estranho...)"; \
			fi; \
		done; \
	done
	@echo "----------------------------------------"
	@echo "--- ğŸ Testes concluÃ­dos ---"


test: update-hosts curl-test